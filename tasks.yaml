# TODO: renovate setup
# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/uds-cli/v0.10.4/tasks.schema.json

includes:
  - create: ./tasks/create.yaml
  - deploy: ./tasks/deploy.yaml
  - publish: ./tasks/publish.yaml
  - setup: ./tasks/setup.yaml
  - create-core: https://raw.githubusercontent.com/defenseunicorns/uds-core/v0.19.0/tasks/create.yaml
  - deploy-core: https://raw.githubusercontent.com/defenseunicorns/uds-core/v0.19.0/tasks/deploy.yaml

variables:
  - name: VERSION
    description: "Explicitly set the version, overriding the official release tag"
    # x-release-please-start-version
    default: "0.3.0"
    # x-release-please-end

  - name: REGISTRY_OPTIONS
    description: "Registry options for local development or private registry support"
    default: ""

tasks:
  - name: uds-rke2
    description: "Complete a stand-up and stand-down of ONLY the RKE2 cluster"
    actions:
      - task: create:uds-rke2
      - task: deploy:uds-rke2-bootstrap
        with:
          joinToken: "my-test-token"

  - name: uds-rke2-local-path-latest
    description: "Bootstrap a new RKE2 cluster, with Local Path Provisioner Zarf Init, MinIO, and UDS Core packages (LATEST)"
    actions:
      # Destroy and clean-up any previous installations
      - task: setup:uds-rke2-destroy
      - task: setup:full-clean

      # UDS bundles
      - task: create:uds-rke2-local-path-bundle
      - task: deploy:uds-rke2-local-path-bundle

  # The following action must be prepended with REGISTRY_OPTIONS and VERSION variables for it to function as intended:
  # REGISTRY_OPTIONS="--insecure --registry-override ghcr.io=localhost:5000"
  # VERSION="0.3.0.dev"
  - name: uds-rke2-local-path-dev
    description: "Bootstrap a new RKE2 cluster, with Local Path Provisioner Zarf Init, MinIO, and UDS Core packages (DEV)"
    actions:
      # Destroy and clean-up any previous installations
      - task: setup:uds-rke2-destroy
      - task: setup:full-clean

      # Zarf packages
      - task: create:uds-rke2
      - task: publish:uds-rke2
      - task: setup:semi-clean
      - task: create:uds-rke2-infrastructure
      - task: publish:uds-rke2-infrastructure
      - task: setup:semi-clean
      - task: create:uds-rke2-exemptions-local-path
      - task: publish:uds-rke2-exemptions-local-path
      - task: setup:semi-clean
      - task: create:uds-rke2-exemptions-longhorn
      - task: publish:uds-rke2-exemptions-longhorn
      - task: setup:semi-clean
      - task: create:uds-rke2-exemptions-rook-ceph
      - task: publish:uds-rke2-exemptions-rook-ceph
      - task: setup:semi-clean
      - task: create:local-path
      - task: publish:local-path
      - task: setup:semi-clean
      - task: create:local-path-init
      - task: publish:local-path-init
      - task: setup:semi-clean
      - task: create:rook-ceph
      - task: publish:rook-ceph
      - task: setup:semi-clean
      - task: create:rook-ceph-init
      - task: publish:rook-ceph-init
      - task: setup:semi-clean
      - task: create:minio
      - task: publish:minio
      - task: setup:semi-clean
      - task: create:leapfrogai-workarounds
      - task: publish:leapfrogai-workarounds
      - task: setup:semi-clean

      # UDS bundles
      - task: create:uds-rke2-local-path-bundle-dev
      - task: deploy:uds-rke2-local-path-bundle-dev

  - name: release
    description: "Builds and publishes all Zarf packages and UDS bundles in the repository"
    actions:
      # Destroy and clean-up any previous installations
      - task: setup:uds-rke2-destroy
      - task: setup:full-clean

      # Zarf packages
      - task: create:uds-rke2
      - task: publish:uds-rke2
      - task: setup:full-clean
      - task: create:uds-rke2-infrastructure
      - task: publish:uds-rke2-infrastructure
      - task: setup:full-clean
      - task: create:uds-rke2-exemptions-local-path
      - task: publish:uds-rke2-exemptions-local-path
      - task: setup:full-clean
      - task: create:uds-rke2-exemptions-longhorn
      - task: publish:uds-rke2-exemptions-longhorn
      - task: setup:full-clean
      - task: create:uds-rke2-exemptions-rook-ceph
      - task: publish:uds-rke2-exemptions-rook-ceph
      - task: setup:full-clean
      - task: create:local-path
      - task: publish:local-path
      - task: setup:full-clean
      - task: create:local-path-init
      - task: publish:local-path-init
      - task: setup:full-clean
      - task: create:rook-ceph
      - task: publish:rook-ceph
      - task: setup:full-clean
      - task: create:rook-ceph-init
      - task: publish:rook-ceph-init
      - task: setup:full-clean
      - task: create:minio
      - task: publish:minio
      - task: setup:full-clean
      - task: create:leapfrogai-workarounds
      - task: publish:leapfrogai-workarounds
      - task: setup:full-clean

      # UDS bundles
      - task: create:uds-rke2-local-path-bundle
      - task: publish:uds-rke2-local-path-bundle
