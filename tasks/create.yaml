# TODO: renovate setup
# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/uds-cli/v0.10.4/tasks.schema.json

includes:
  - setup: ./setup.yaml

variables:
  - name: VERSION
    description: "Explicitly set the version, overriding the official release tag"
    # x-release-please-start-version
    default: "0.1.0"
    # x-release-please-end

tasks:
  - name: all
    description: "Builds all Zarf packages in the repository"
    actions:
      - task: setup:temp-build-folder
      - task: uds-rke2
      # TODO: add these back in when actually built
      # - task: local-path
      # - task: local-path-init
      # - task: longhorn
      # - task: longhorn-init
      - task: rook-ceph
      - task: rook-ceph-init-multi-node
      # - task: rook-ceph-init-single-node
      - task: uds-rke2-exemptions
      - task: minio

  - name: create
    description: "Create a Zarf package for the amd64 architectures"
    inputs:
      path:
        description: "Path to the Zarf package being created"
        required: true
      outputPath:
        description: "Output path to the Zarf package being created"
        required: true
      zarfConfig:
        description: "Zarf Config of the Zarf package being created"
        required: true
    actions:
      - description: "Create the Zarf package for the amd64 architectures"
        cmd: |
          sudo ZARF_CONFIG="${{ .inputs.zarfConfig }}" uds zarf package create "${{ .inputs.path }}" \
            -o "${{ .inputs.outputPath }}" \
            --set VERSION=${VERSION} \
            --no-progress \
            --no-log-file \
            --log-level warn \
            -a amd64 \
            --confirm

  - name: init
    description: "Create a custom Zarf Init package for the amd64 architectures"
    inputs:
      flavor:
        description: "Flavor of the Zarf package being created"
        required: true
      outputPath:
        description: "Output path to the Zarf package being created"
        required: true
    actions:
      - description: "Create the Zarf package for the amd64 architectures"
        cmd: |
          sudo ZARF_CONFIG="packages/init/zarf-config.yaml" uds zarf package create packages/init/ \
            -o "${{ .inputs.outputPath }}" \
            --flavor "${{ .inputs.flavor }}" \
            --set AGENT_IMAGE_TAG=$(uds zarf version) \
            --no-progress \
            --no-log-file \
            --log-level warn \
            -a amd64 \
            --confirm

  - name: uds-rke2
    description: "Build the UDS RKE2 Zarf package"
    actions:
      - task: create
        with:
          path: packages/uds-rke2/
          outputPath: build/packages/
          zarfConfig: packages/uds-rke2/zarf-config.yaml

  - name: local-path
    description: "Build the Local Path Provisioner Zarf package"
    actions:
      - task: create
        with:
          path: packages/local-path/
          outputPath: build/packages/local-path/
          zarfConfig: packages/local-path/zarf-config.yaml

  - name: local-path-init
    description: "Build the Local Path Provisioner Zarf Init package"
    actions:
      - task: init
        with:
          flavor: local-path
          outputPath: build/packages/local-path

  - name: longhorn
    description: "Build the Longhorn Zarf package"
    actions:
      - task: create
        with:
          path: packages/longhorn/
          outputPath: build/packages/longhorn/
          zarfConfig: packages/longhorn/zarf-config.yaml

  - name: longhorn-init
    description: "Build the Longhorn Zarf Init package"
    actions:
      - task: init
        with:
          flavor: longhorn
          outputPath: build/packages/longhorn

  - name: rook-ceph
    description: "Build the Rook-Ceph Zarf package"
    actions:
      - task: create
        with:
          path: packages/rook-ceph/
          outputPath: build/packages/rook-ceph
          zarfConfig: packages/rook-ceph/zarf-config.yaml

  - name: rook-ceph-init-multi-node
    description: "Build the Rook-Ceph Zarf Init package"
    actions:
      - task: init
        with:
          flavor: rook-ceph
          outputPath: build/packages/rook-ceph/multi-node

  - name: uds-rke2-exemptions
    description: "Build the UDS RKE2 service Pepr policy exemptions package"
    actions:
      - task: create
        with:
          path: packages/exemptions/
          outputPath: build/packages/
          zarfConfig: packages/exemptions/zarf-config.yaml

  - name: minio
    description: "Build the MinIO package"
    actions:
      - task: create
        with:
          path: packages/minio/
          outputPath: build/packages/
          zarfConfig: packages/minio/zarf-config.yaml
